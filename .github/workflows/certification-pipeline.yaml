name: RHDH Plugin Certification Pipeline

on:
  workflow_dispatch:

jobs:
  detect-changes:
    name: Detect PR Changes
    runs-on: ubuntu-latest
    outputs:
      modified_files: ${{ steps.changed-files.outputs.all_changed_files }}
      plugin_name: ${{ steps.extract-plugin.outputs.plugin_name }}
      package_yaml: ${{ steps.extract-plugin.outputs.package_yaml }}
    steps:
      # Checkout the repository
      - name: üõéÔ∏è Checkout Repository
        uses: actions/checkout@v4

      # Identify which plugin files were modified
      - name: üîç Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: plugins/**/package.yaml

      # Upload only necessary files to reduce artifact size
      - name: üì• Save Repository as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repo-artifact
          path: |
            plugins/
            values.yaml
            rhdh/
          retention-days: 7

      - name: Confirm Artifact Upload
        run: |
          echo "Artifact repo-artifact should be uploaded now!"

      # Extract plugin name and package.yaml path
      - name: üì• Extract Plugin Name and Package.yaml Path
        id: extract-plugin
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          if [[ "$file" == plugins/*/package.yaml ]]; then
            PLUGIN_NAME=$(echo "$file" | cut -d'/' -f2)
            echo "PLUGIN_NAME=$PLUGIN_NAME" >> $GITHUB_OUTPUT
            echo "PACKAGE_YAML=$file" >> $GITHUB_OUTPUT
          fi
          done

  setup-and-deploy:
    name: Setup and Deploy - ${{ needs.detect-changes.outputs.plugin_name }}
    runs-on: ubuntu-latest
    needs: detect-changes
    steps:
      # List available artifacts before downloading
      - name: üìù List Available Artifacts
        run: |
          echo "Available artifacts:"
          gh run list --json artifacts --jq '.artifacts[].name'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üìù List Available Artifacts
        run: |
          echo "üîç Listing available artifacts..."
          gh run list --json artifacts --jq '.artifacts[].name'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Download the repository artifact
      - name: Download Repository Artifact
        uses: actions/download-artifact@v4
        with:
          name: repo-artifact
          path: .
        continue-on-error: true

      - name: Check if Artifact Exists
        run: |
          if [ ! -d "rhdh" ]; then
            echo "ERROR: Artifact repo-artifact not found or empty!"
            exit 1
          fi
          echo "Artifact repo-artifact successfully downloaded!"

      # Set up Kubeconfig and install Helm
      - name: üåê Set Up Kubeconfig and Install Helm
      - name: üåê Set Up Kubeconfig and Install Helm
        run: |
          sudo apt update && sudo apt install -y g++
          curl https://baltocdn.com/helm/signing.asc | gpg --dearmor | sudo tee /usr/share/keyrings/helm.gpg > /dev/null
          sudo apt-get install -y apt-transport-https
          sudo apt-get update && sudo apt-get install -y helm
        env:
          KUBESECRET: ${{ secrets.KUBE_CONFIG }}

      # Deploy Red Hat Developer Hub
      - name: üì¶ Deploy Red Hat Developer Hub
        run: |
          helm repo add openshift-helm-charts https://charts.openshift.io/
          helm --kubeconfig /opt/.kube/config install -f values.yaml \
            redhat-developer-hub openshift-helm-charts/redhat-developer-hub \
            --namespace rhdh-smoketest --create-namespace

      # Install dynamic plugin if changes were detected
      - name: Install Dynamic Plugin
        if: ${{ needs.detect-changes.outputs.modified_files != '' }}
        run: |
          helm --kubeconfig /opt/.kube/config upgrade --reuse-values -f "${{ needs.detect-changes.outputs.package_yaml }}" \
            redhat-developer-hub openshift-helm-charts/redhat-developer-hub \
            --namespace rhdh-smoketest

  run-smoke-tests:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    needs: setup-and-deploy
    env:
      BASE_URL: https://redhat-developer-hub-rhdh-smoketest.apps.dancurran-lab2025.opdev.io/
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      # Cache dependencies to speed up execution
      - name: üì¶ Cache Dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.npm
            ~/.cache/yarn
            rhdh/e2e-tests/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # Cache Playwright browsers to avoid re-downloading
      - name: üì¶ Cache Playwright Browsers
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      # Install dependencies
      - name: üöÄ Install Dependencies
        run: |
          cd rhdh
          yarn install

      # Install Playwright browsers
      - name: üî¨ Install Playwright Dependencies
        run: |
          cd rhdh/e2e-tests
          yarn playwright install chromium

      # Run Playwright tests
      - name: ‚úÖ Run Playwright Smoke Test
        run: |
          cd rhdh/e2e-tests
          yarn playwright test \
            playwright/e2e/plugins/dynamic-plugins-info/dynamic-plugins-info.spec.ts \
            --project="smoke-test" \
            --output=playwright-report

  upload-logs-and-report:
    name: Upload Logs and Deploy Report
    runs-on: ubuntu-latest
    needs: run-smoke-tests
    if: always()
    steps:
      # Upload Playwright report as an artifact
      - name: üì§ Upload Playwright Report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: rhdh/e2e-tests/playwright-report/
          retention-days: 7

      # Deploy Playwright report to GitHub Pages
      - name: üöÄ Deploy Playwright Report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: rhdh/e2e-tests/playwright-report/
          keep_files: true

      # Print the Playwright Report URL
      - name: üîó Print Playwright Report Link
        run: |
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO_NAME=$(basename "${{ github.repository }}")
          echo "‚úÖ Playwright Report is available!"
          echo "üîó [Click here to view the report](https://${REPO_OWNER}.github.io/${REPO_NAME}/playwright-report/index.html)"

  cleanup:
    name: Cleanup Deployment
    runs-on: ubuntu-latest
    needs: upload-logs-and-report
    if: always()
    steps:
      # Get Helm Release Name
      - name: üìú Get Helm Release Name
        run: |
          RELEASE_NAME=$(helm --kubeconfig /opt/.kube/config list -n rhdh-smoketest -q | head -n 1)
          if [ -z "$RELEASE_NAME" ]; then
            echo "‚ö†Ô∏è No Helm releases found, skipping uninstallation."
            exit 0
          fi
          echo "Found Helm release: $RELEASE_NAME"
          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV

      # Uninstall Helm release
      - name: ‚ùå Uninstall Helm Release
        run: |
          helm uninstall --kubeconfig /opt/.kube/config $RELEASE_NAME --namespace rhdh-smoketest
          echo "‚úÖ Helm release '$RELEASE_NAME' has been uninstalled."
        env:
          RELEASE_NAME: ${{ env.RELEASE_NAME }}
